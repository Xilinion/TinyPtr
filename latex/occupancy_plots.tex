\section{Hash Function Occupancy Distribution Analysis}

% Read split CSVs for easier plotting
\pgfplotstableread[col sep=comma]{../results/csv/occupancy_experimental_box.csv}{\occbox}
\pgfplotstableread[col sep=comma]{../results/csv/occupancy_poisson.csv}{\occpois}

\begin{figure}[p]
    \centering

    % Box plot style occupancy distribution
    \begin{subfigure}[b]{0.48\textwidth}
        \centering
        \begin{tikzpicture}
            \begin{axis}[
                    width=8cm,
                    height=7cm,
                    xlabel={Number of Balls per Bin},
                    ylabel={Probability (Log Scale)},
                    ymode=log,
                    ymin=1e-8,
                    ymax=1,
                    xmin=-0.5,
                    xmax=10.5,
                    xtick={0,1,2,3,4,5,6,7,8,9,10,11},
                    xticklabels={0,1,2,3,4,5,6,7,8,9,10,11},
                    grid=major,
                    grid style={gray!30},
                    legend pos=south west,
                    legend style={font=\small},
                    tick label style={font=\small},
                    label style={font=\small},
                    title={Experimental Distribution vs Theory},
                    title style={font=\small}
                ]

                % Box plots for occupancy 0-11 using manual extraction
                \foreach \i in {0,1,2,3,4,5,6,7,8,9,10,11} {
                    \pgfplotstablegetelem{\i}{lower_whisker}\of{\occbox}\edef\lw{\pgfplotsretval}
                    \pgfplotstablegetelem{\i}{lower}\of{\occbox}\edef\lq{\pgfplotsretval}
                    \pgfplotstablegetelem{\i}{median}\of{\occbox}\edef\med{\pgfplotsretval}
                    \pgfplotstablegetelem{\i}{upper}\of{\occbox}\edef\uq{\pgfplotsretval}
                    \pgfplotstablegetelem{\i}{upper_whisker}\of{\occbox}\edef\uw{\pgfplotsretval}
                    \edef\tempstyle{every boxplot/.style={fill=exp1!25, draw=exp1}, boxplot prepared={draw position=\i, lower whisker=\lw, lower quartile=\lq, median=\med, upper quartile=\uq, upper whisker=\uw}}
                    \expandafter\addplot\expandafter+\expandafter[\tempstyle] coordinates {};
                }
                \addlegendentry{Experimental (box plot)}

                % Plot smooth Poisson line (theoretical data)
                \addplot[PoissonLineStyle, mark=none] table[
                        x=x,
                        y=y
                    ] {\occpois};
                \addlegendentry{Poisson Theory ($\lambda=1$)}
            \end{axis}
        \end{tikzpicture}
        \caption{Distribution Comparison (Log Scale)}
    \end{subfigure}
    \hfill
    % Linear scale for low occupancy values
    \begin{subfigure}[b]{0.48\textwidth}
        \centering
        \begin{tikzpicture}
            \begin{axis}[
                    width=8cm,
                    height=7cm,
                    xlabel={Number of Balls per Bin},
                    ylabel={Probability},
                    xmin=-0.5,
                    xmax=5.5,
                    ymin=0,
                    xtick={1,2,3,4,5,6},
                    xticklabels={0,1,2,3,4,5},
                    grid=major,
                    grid style={gray!30},
                    legend pos=south west,
                    legend style={font=\small},
                    tick label style={font=\small},
                    label style={font=\small},
                    title={Linear Scale (0-5 balls)},
                    title style={font=\small}
                ]

                % Box plots for occupancy 0-5 using manual extraction
                \foreach \i in {0,1,2,3,4,5} {
                    \pgfplotstablegetelem{\i}{lower_whisker}\of{\occbox}\edef\lw{\pgfplotsretval}
                    \pgfplotstablegetelem{\i}{lower}\of{\occbox}\edef\lq{\pgfplotsretval}
                    \pgfplotstablegetelem{\i}{median}\of{\occbox}\edef\med{\pgfplotsretval}
                    \pgfplotstablegetelem{\i}{upper}\of{\occbox}\edef\uq{\pgfplotsretval}
                    \pgfplotstablegetelem{\i}{upper_whisker}\of{\occbox}\edef\uw{\pgfplotsretval}
                    \edef\tempstyle{every boxplot/.style={fill=exp1!25, draw=exp1}, boxplot prepared={draw position=\i, lower whisker=\lw, lower quartile=\lq, median=\med, upper quartile=\uq, upper whisker=\uw}}
                    \expandafter\addplot\expandafter+\expandafter[\tempstyle] coordinates {};
                }
                \addlegendentry{Experimental (box plot)}

                % Plot smooth Poisson line (theoretical data)
                \addplot[PoissonLineStyle, mark=none] table[
                        x=x,
                        y=y,
                        restrict expr to domain={\thisrow{x}}{0:5}
                    ] {\occpois};
                \addlegendentry{Poisson Theory ($\lambda=1$)}
            \end{axis}
        \end{tikzpicture}
        \caption{Common Values (Linear Scale)}
    \end{subfigure}

    \caption{Hash Function Occupancy Distribution Analysis. Left: Full distribution on logarithmic scale showing rare events. Right: Linear scale focusing on common occupancy values (0-5 balls). The theoretical Poisson distribution is calculated directly in LaTeX. All experimental runs are shown as individual points.}
    \label{fig:occupancy_analysis}
\end{figure} 